{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}My Profile - Campus Marketplace{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" 
                             alt="{{ user.username }}'s profile picture" 
                             class="img-fluid rounded-circle mb-3" 
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mb-3 mx-auto" 
                             style="width: 150px; height: 150px;">
                            <i class="fas fa-user fa-4x text-light"></i>
                        </div>
                    {% endif %}
                    <h4>{{ user.full_name }}</h4>
                    <p class="text-muted">@{{ user.username }}</p>
                    <span class="badge bg-primary">{{ user.get_user_type_display }}</span>
                    
                    <div class="mt-4">
                        <a href="{% url 'accounts:profile_edit' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit"></i> Edit Profile
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Profile Navigation -->
            <div class="list-group">
                <a href="{% url 'accounts:profile' %}" 
                   class="list-group-item list-group-item-action {% if active_tab == 'profile' %}active{% endif %}">
                    <i class="fas fa-user me-2"></i> My Profile
                </a>
                <a href="{% url 'accounts:profile_edit' %}" 
                   class="list-group-item list-group-item-action {% if active_tab == 'edit_profile' %}active{% endif %}">
                    <i class="fas fa-edit me-2"></i> Edit Profile
                </a>
                <a href="{% url 'accounts:change_password' %}" 
                   class="list-group-item list-group-item-action {% if active_tab == 'change_password' %}active{% endif %}">
                    <i class="fas fa-key me-2"></i> Change Password
                </a>
                <!-- Add more navigation items as needed -->
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Profile Information</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Full Name</h6>
                            <p>{{ user.first_name }} {{ user.last_name|default:"" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Username</h6>
                            <p>@{{ user.username }}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Email</h6>
                            <p>{{ user.email }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Phone Number</h6>
                            <p>{{ user.phone_number|default:"Not provided" }}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Student ID</h6>
                            <p>{{ user.student_id|default:"Not provided" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Account Type</h6>
                            <p>{{ user.get_user_type_display }}</p>
                        </div>
                    </div>
                    
                    {% if user.bio %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>Bio</h6>
                            <p>{{ user.bio|linebreaks }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Member Since</h6>
                            <p>{{ user.date_joined|date:"F j, Y" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Last Updated</h6>
                            <p>{{ user.updated_at|date:"F j, Y" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<div class="row">
    <div class="col-md-4">
        <!-- Profile Card (unchanged) -->
        <div class="card mb-4">
            <div class="card-body text-center">
                {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" alt="Profile Picture" 
                     class="rounded-circle border" width="150" height="150" 
                     style="object-fit: cover;">
                {% else %}
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                     style="width: 150px; height: 150px; font-size: 3rem;">
                    {{ user.username|first|upper }}
                </div>
                {% endif %}
                
                <h4>{{ user.username }}</h4>
                <p class="text-muted">{{ user.email }}</p>
                
                <div class="mb-3">
                    <span class="badge bg-{% if user.user_type == 'student' %}primary{% elif user.user_type == 'vendor' %}success{% else %}secondary{% endif %}">
                        {{ user.get_user_type_display }}
                    </span>
                    {% if user.is_staff %}
                    <span class="badge bg-warning">Staff</span>
                    {% endif %}
                    {% if user.is_superuser %}
                    <span class="badge bg-danger">Admin</span>
                    {% endif %}
                </div>
                
                {% if user.student_id %}
                <p><i class="bi bi-person-badge"></i> {{ user.student_id }}</p>
                {% endif %}
                
                {% if user.phone_number %}
                <p><i class="bi bi-telephone"></i> {{ user.phone_number }}</p>
                {% endif %}
                
                <p class="text-muted small">
                    <i class="bi bi-calendar"></i> Member since {{ user.date_joined|date:"F j, Y" }}
                </p>
            </div>
        </div>
        
        <!-- Admin Quick Links (Only for superusers) -->
        {% if user.is_superuser or user.is_staff %}
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Admin Panel</h6>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="{% url 'admin:index' %}" class="list-group-item list-group-item-action" target="_blank">
                        <i class="bi bi-speedometer2 me-2"></i> Django Admin
                    </a>
                    <a href="{% url 'admin:accounts_customuser_changelist' %}" class="list-group-item list-group-item-action" target="_blank">
                        <i class="bi bi-people me-2"></i> Manage Users
                    </a>
                    <a href="{% url 'admin:marketplace_product_changelist' %}" class="list-group-item list-group-item-action" target="_blank">
                        <i class="bi bi-cart me-2"></i> Manage Products
                    </a>
                    <a href="{% url 'admin:lostfound_lostfounditem_changelist' %}" class="list-group-item list-group-item-action" target="_blank">
                        <i class="bi bi-search me-2"></i> Manage Lost & Found
                    </a>
                    <a href="{% url 'admin:housing_property_changelist' %}" class="list-group-item list-group-item-action" target="_blank">
                        <i class="bi bi-house me-2"></i> Manage Properties
                    </a>
                    <a href="{% url 'admin:food_restaurant_changelist' %}" class="list-group-item list-group-item-action" target="_blank">
                        <i class="bi bi-egg-fried me-2"></i> Manage Restaurants
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#banUserModal">
                        <i class="bi bi-ban me-2"></i> Ban User
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#moderationQueueModal">
                        <i class="bi bi-eye me-2"></i> Moderation Queue
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Account Stats (unchanged) -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Account Statistics</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-cart text-primary me-2"></i> Products Listed</span>
                        <span class="badge bg-primary rounded-pill">{{ product_count }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-search text-warning me-2"></i> Reports Made</span>
                        <span class="badge bg-warning rounded-pill">{{ lostfounditem_count }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-house text-success me-2"></i> Properties Listed</span>
                        <span class="badge bg-success rounded-pill">{{ property_count }}</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-egg-fried text-danger me-2"></i> Restaurants Listed</span>
                        <span class="badge bg-danger rounded-pill">{{ restaurant_count }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <!-- Edit Profile Form (unchanged) -->
        <!-- ... existing form code ... -->
        
        <!-- Admin Modals (Only for superusers/staff) -->
        {% if user.is_superuser or user.is_staff %}
        <!-- Ban User Modal -->
        <div class="modal fade" id="banUserModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="bi bi-ban me-2"></i>Ban/Suspend User</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <!-- Will be populated via AJAX -->
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Moderation Queue Modal -->
        <div class="modal fade" id="moderationQueueModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Content Moderation Queue</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="moderationTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#reportedContent">Reported Content</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recentPosts">Recent Posts</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#flaggedUsers">Flagged Users</button>
                            </li>
                        </ul>
                        <div class="tab-content p-3">
                            <div class="tab-pane fade show active" id="reportedContent">
                                <p>Content reported by users will appear here.</p>
                            </div>
                            <div class="tab-pane fade" id="recentPosts">
                                <p>Recent posts across all platforms.</p>
                            </div>
                            <div class="tab-pane fade" id="flaggedUsers">
                                <p>Users flagged for suspicious activity.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript for Admin Features -->
{% if user.is_superuser or user.is_staff %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load users for ban modal
    const banModal = document.getElementById('banUserModal');
    if (banModal) {
        banModal.addEventListener('show.bs.modal', function() {
            fetch('/accounts/api/users/')
                .then(response => response.json())
                .then(users => {
                    const tableBody = document.getElementById('userTableBody');
                    tableBody.innerHTML = '';
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="badge ${user.user_type === 'student' ? 'bg-primary' : 'bg-secondary'}">${user.user_type}</span></td>
                            <td>
                                <span class="badge ${user.is_active ? 'bg-success' : 'bg-danger'}">
                                    ${user.is_active ? 'Active' : 'Banned'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm ${user.is_active ? 'btn-danger' : 'btn-success'}" 
                                        onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                    ${user.is_active ? 'Ban' : 'Unban'}
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="viewUserDetails(${user.id})">
                                    Details
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    document.getElementById('userTableBody').innerHTML = 
                        '<tr><td colspan="5" class="text-center text-danger">Error loading users</td></tr>';
                });
        });
    }
});

// Toggle user status (ban/unban)
function toggleUserStatus(userId, activate) {
    if (!confirm(activate ? 'Unban this user?' : 'Ban this user? This will prevent them from logging in.')) {
        return;
    }
    
    fetch(`/accounts/api/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({activate: activate})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Refresh the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('banUserModal'));
            modal.hide();
            modal.show();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endif %}

<!-- JavaScript for Image Preview (unchanged) -->
<script>
// ... existing image preview code ...
</script>
{% endblock %}