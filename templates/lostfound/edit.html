{% extends 'base.html' %}

{% block title %}Edit {{ item.title }} - Campus Marketplace{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">
                    <i class="bi bi-pencil"></i> Edit Item: {{ item.title }}
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> You are editing your {{ item.get_item_type_display }} item.
                </div>
                
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">Item Title *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger">
                            {{ form.title.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="mb-4">
    <label class="form-label fw-bold">Item Type</label>
    <p class="text-muted small mb-2">Current: 
        {% if item.item_type == 'lost' %}
        <span class="badge bg-danger">Lost Item</span>
        {% else %}
        <span class="badge bg-success">Found Item</span>
        {% endif %}
    </p>
    
    <div class="form-check-group">
        {% for choice in form.item_type.field.choices %}
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" 
                   name="{{ form.item_type.name }}" 
                   id="id_{{ form.item_type.name }}_{{ forloop.counter0 }}" 
                   value="{{ choice.0 }}"
                   {% if form.item_type.value == choice.0 or item.item_type == choice.0 %}checked{% endif %}>
            <label class="form-check-label" for="id_{{ form.item_type.name }}_{{ forloop.counter0 }}">
                {% if choice.0 == 'lost' %}
                <i class="bi bi-search text-danger"></i> Lost Item
                {% else %}
                <i class="bi bi-check-circle text-success"></i> Found Item
                {% endif %}
            </label>
        </div>
        {% endfor %}
    </div>
    
    {% if form.item_type.errors %}
    <div class="text-danger small mt-2">
        {{ form.item_type.errors }}
    </div>
    {% endif %}
</div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                {% for value, label in form.fields.status.choices %}
                                <option value="{{ value }}" {% if item.status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger">
                            {{ form.description.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        {% if item.item_type == 'lost' %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lost Location *</label>
                            {{ form.location_lost }}
                            {% if form.location_lost.errors %}
                            <div class="text-danger">
                                {{ form.location_lost.errors }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date Lost *</label>
                            {{ form.date_lost }}
                            {% if form.date_lost.errors %}
                            <div class="text-danger">
                                {{ form.date_lost.errors }}
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Found Location *</label>
                            {{ form.location_found }}
                            {% if form.location_found.errors %}
                            <div class="text-danger">
                                {{ form.location_found.errors }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date Found *</label>
                            {{ form.date_found }}
                            {% if form.date_found.errors %}
                            <div class="text-danger">
                                {{ form.date_found.errors }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Email *</label>
                            {{ form.contact_email }}
                            {% if form.contact_email.errors %}
                            <div class="text-danger">
                                {{ form.contact_email.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Phone (Optional)</label>
                            {{ form.contact_phone }}
                            {% if form.contact_phone.errors %}
                            <div class="text-danger">
                                {{ form.contact_phone.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Current Image</label>
                        {% if item.image %}
                        <div class="mb-2">
                            <img src="{{ item.image.url }}" class="img-thumbnail" alt="Current image" style="max-height: 200px;">
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="clear_image" id="clear_image">
                                <label class="form-check-label text-danger" for="clear_image">
                                    Remove current image
                                </label>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">No image uploaded</p>
                        {% endif %}
                        
                        <label class="form-label">Upload New Image (Optional)</label>
                        {{ form.image }}
                        {% if form.image.errors %}
                        <div class="text-danger">
                            {{ form.image.errors }}
                        </div>
                        {% endif %}
                        <small class="text-muted">Leave empty to keep current image. Max size: 5MB. Supported formats: JPG, PNG</small>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'lostfound:detail' item.pk %}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-warning">Update Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set max date for date inputs
    const today = new Date().toISOString().split('T')[0];
    
    // Set max attribute for date inputs
    const dateLostInput = document.getElementById('id_date_lost');
    const dateFoundInput = document.getElementById('id_date_found');
    
    if (dateLostInput) {
        dateLostInput.max = today;
    }
    
    if (dateFoundInput) {
        dateFoundInput.max = today;
    }
    
    // Real-time validation
    function validateDate(input) {
        const selectedDate = new Date(input.value);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        
        if (selectedDate > todayDate) {
            input.classList.add('is-invalid');
            let errorDiv = input.parentNode.querySelector('.date-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger small date-error';
                input.parentNode.appendChild(errorDiv);
            }
            errorDiv.textContent = 'Date cannot be in the future!';
            return false;
        } else {
            input.classList.remove('is-invalid');
            const errorDiv = input.parentNode.querySelector('.date-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            return true;
        }
    }
    
    if (dateLostInput) {
        dateLostInput.addEventListener('change', function() {
            validateDate(this);
        });
    }
    
    if (dateFoundInput) {
        dateFoundInput.addEventListener('change', function() {
            validateDate(this);
        });
    }
});
</script>
{% endblock %}