{% extends 'housing/base.html' %}

{% block title %}{{ listing.title }} - Student Housing{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

<style>
    .carousel-item img {
        height: 400px;
        object-fit: cover;
    }
    .property-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }
    .info-row:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 600;
        color: #495057;
    }
    .info-value {
        color: #28a745;
        font-weight: 500;
    }
    .amenity-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 8px 12px;
        border-radius: 20px;
        display: inline-block;
        margin: 5px;
    }
    /* Map styles */
    #housing-map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-top: 15px;
        z-index: 1;
    }
    .map-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 400px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 15px;
    }
    .map-marker {
        background-color: #dc3545;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Left Column: Images & Details -->
    <div class="col-lg-8">
        <!-- Image Carousel -->
        <div class="card mb-4">
            <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% if listing.main_image %}
                    <div class="carousel-item active">
                        <img src="{{ listing.main_image.url }}" class="d-block w-100" alt="{{ listing.title }}">
                    </div>
                    {% endif %}
                    {% if listing.image_2 %}
                    <div class="carousel-item">
                        <img src="{{ listing.image_2.url }}" class="d-block w-100" alt="{{ listing.title }} - Image 2">
                    </div>
                    {% endif %}
                    {% if listing.image_3 %}
                    <div class="carousel-item">
                        <img src="{{ listing.image_3.url }}" class="d-block w-100" alt="{{ listing.title }} - Image 3">
                    </div>
                    {% endif %}
                    {% if listing.image_4 %}
                    <div class="carousel-item">
                        <img src="{{ listing.image_4.url }}" class="d-block w-100" alt="{{ listing.title }} - Image 4">
                    </div>
                    {% endif %}
                </div>
                
                {% if listing.main_image or listing.image_2 or listing.image_3 or listing.image_4 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Listing Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">Property Details</h4>
            </div>
            <div class="card-body">
                <div class="property-info mb-4">
                    <div class="info-row">
                        <span class="info-label">Listing Type:</span>
                        <span class="info-value">{{ listing.get_listing_type_display }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Property Type:</span>
                        <span class="info-value">{{ listing.get_property_type_display }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Bedrooms:</span>
                        <span class="info-value">{{ listing.bedrooms }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Bathrooms:</span>
                        <span class="info-value">{{ listing.bathrooms }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Furnished:</span>
                        <span class="info-value">{{ listing.get_furnished_display }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Square Meters:</span>
                        <span class="info-value">{% if listing.square_meters %}{{ listing.square_meters }} mÂ²{% else %}Not specified{% endif %}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Utilities Included:</span>
                        <span class="info-value">{% if listing.utilities_included %}Yes{% else %}No{% endif %}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Available From:</span>
                        <span class="info-value">{{ listing.available_from|date:"F d, Y" }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Lease Duration:</span>
                        <span class="info-value">{% if listing.lease_duration %}{{ listing.lease_duration }}{% else %}Flexible{% endif %}</span>
                    </div>
                </div>
                
                <!-- Description -->
                <h5>Description</h5>
                <p>{{ listing.description|linebreaks }}</p>
                
                <!-- Amenities -->
                {% if amenities_list %}
                <h5 class="mt-4">Amenities</h5>
                <div class="amenities-list">
                    {% for amenity in amenities_list %}
                    <span class="amenity-badge">
                        <i class="bi bi-check-circle text-success me-1"></i>{{ amenity }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Location with Map -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">Location</h4>
            </div>
            <div class="card-body">
                <p><i class="bi bi-map-marker-alt text-danger me-2"></i>{{ listing.address }}</p>
                <p><i class="bi bi-city text-info me-2"></i>{{ listing.city }}{% if listing.neighborhood %}, {{ listing.neighborhood }}{% endif %}</p>
                
                <!-- Map Container -->
                {% if listing.latitude and listing.longitude %}
                <div id="housing-map"></div>
                <p class="text-muted small mt-2">
                    <i class="bi bi-info-circle"></i> The marker shows the approximate location. Exact address will be provided upon contact.
                </p>
                {% else %}
                <div class="map-loading">
                    <div class="text-center">
                        <i class="bi bi-map text-muted" style="font-size: 3rem;"></i>
                        <p class="mt-2">Map location not available for this listing</p>
                        <p class="small text-muted">Contact the lister for exact directions</p>
                    </div>
                </div>
                {% endif %}
                
                <!-- Directions Button -->
                {% if listing.latitude and listing.longitude %}
                <div class="mt-3">
                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ listing.latitude }},{{ listing.longitude }}" 
                       target="_blank" 
                       class="btn btn-primary btn-sm">
                        <i class="bi bi-compass me-1"></i> Get Directions (Google Maps)
                    </a>
                    <a href="https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&route=%3B{{ listing.latitude }}%2C{{ listing.longitude }}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm ms-2">
                        <i class="bi bi-signpost-split me-1"></i> OpenStreetMap Directions
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Column: Contact & Actions -->
    <div class="col-lg-4">
        <!-- Price & Contact Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">{{ listing.price_display }}</h4>
                <p class="mb-0 small">
                    {% if listing.deposit > 0 %}
                    Deposit: KSh {{ listing.deposit|floatformat:0 }}
                    {% endif %}
                </p>
            </div>
            <div class="card-body">
                <!-- Favorite Button -->
                {% if user.is_authenticated %}
                <div class="d-grid mb-3">
                    {% if is_favorited %}
                    <a href="{% url 'housing:toggle_favorite' listing.pk %}" class="btn btn-danger">
                        <i class="bi bi-heart-fill"></i> Remove from Favorites
                    </a>
                    {% else %}
                    <a href="{% url 'housing:toggle_favorite' listing.pk %}" class="btn btn-outline-danger">
                        <i class="bi bi-heart"></i> Add to Favorites
                    </a>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Contact Info -->
                <h5>Contact Information</h5>
                <div class="mb-3">
                    <p class="mb-1"><strong>Name:</strong> {{ listing.contact_name }}</p>
                    <p class="mb-1"><strong>Phone:</strong> {{ listing.contact_phone }}</p>
                    {% if listing.contact_email %}
                    <p class="mb-1"><strong>Email:</strong> {{ listing.contact_email }}</p>
                    {% endif %}
                    <p class="mb-0"><small class="text-muted">Contact via: {{ listing.get_contact_preference_display }}</small></p>
                </div>
                
                <!-- Action Buttons for Owner -->
                {% if user.is_authenticated and user == listing.user %}
                <hr>
                <h5>Owner Actions</h5>
                <div class="d-grid gap-2">
                    <a href="{% url 'housing:update_listing' listing.pk %}" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Edit Listing
                    </a>
                    <a href="{% url 'housing:delete_listing' listing.pk %}" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Listing
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Stats Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h6>Listing Stats</h6>
                <p class="mb-1"><i class="bi bi-eye text-info me-2"></i> {{ listing.views_count }} views</p>
                <p class="mb-1"><i class="bi bi-calendar text-success me-2"></i> Posted {{ listing.created_at|timesince }} ago</p>
                <p class="mb-0"><i class="bi bi-person text-primary me-2"></i> Listed by {{ listing.user.username }}</p>
            </div>
        </div>
        
        <!-- Similar Listings -->
        {% if similar_listings %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Similar Listings</h6>
            </div>
            <div class="card-body">
                {% for similar in similar_listings %}
                <div class="mb-3">
                    <h6 class="mb-1">{{ similar.title|truncatechars:30 }}</h6>
                    <p class="mb-1 small text-muted">
                        <i class="bi bi-map-marker-alt"></i> {{ similar.city }}
                    </p>
                    <p class="mb-1 small"><strong>{{ similar.price_display }}</strong></p>
                    <a href="{% url 'housing:listing_detail' similar.pk %}" class="btn btn-sm btn-outline-primary">
                        View
                    </a>
                </div>
                {% if not forloop.last %}<hr>{% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<div id="housing-map" data-lat="{{ listing.latitude }}" data-lng="{{ listing.longitude }}"></div>

{% block extra_js %}
<!-- Leaflet JS for Map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

<script>
    // Initialize carousel
    var carousel = new bootstrap.Carousel(document.getElementById('listingCarousel'), {
        interval: 5000
    });
    
    // Initialize map if coordinates exist
    {% if listing.latitude and listing.longitude %}
    document.addEventListener('DOMContentLoaded', function() {
        const latitude = {{ listing.latitude }};
        const longitude = {{ listing.longitude }};
        
        // Initialize map
        const map = L.map('housing-map').setView([latitude, longitude], 15);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add custom icon
        const housingIcon = L.divIcon({
            html: '<div style="background-color: #dc3545; color: white; padding: 8px 12px; border-radius: 4px; font-weight: bold;">Property</div>',
            className: 'custom-div-icon',
            iconSize: [120, 40],
            iconAnchor: [60, 40]
        });
        
        // Add marker with popup
        const marker = L.marker([latitude, longitude], {icon: housingIcon}).addTo(map);
        
        // Add popup with listing info
        marker.bindPopup(`
            <b>{{ listing.title|escapejs }}</b><br>
            {{ listing.address|escapejs }}<br>
            {{ listing.city|escapejs }}<br>
            <strong>{{ listing.price_display|escapejs }}</strong>
        `);
        
        // Optional: Add circle to show approximate area
        L.circle([latitude, longitude], {
            color: '#28a745',
            fillColor: '#28a745',
            fillOpacity: 0.1,
            radius: 100
        }).addTo(map);
    });
    {% endif %}
</script>
{% endblock %}