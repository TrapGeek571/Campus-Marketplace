{% extends 'housing/base.html' %} {% block title %}{{ title|default:"Create
Listing" }}{% endblock %} {% block extra_css %}
<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  .form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .section-title {
    color: #28a745;
    border-bottom: 2px solid #28a745;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }
  .required-field::after {
    content: " *";
    color: #dc3545;
  }
  /* Map styling */
  #property-map {
    height: 400px;
    width: 100%;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid #dee2e6;
    z-index: 1;
  }
  .map-instructions {
    background: #e9f7fe;
    border-left: 4px solid #17a2b8;
    padding: 10px 15px;
    margin-bottom: 15px;
    font-size: 0.9rem;
  }
  .map-coordinates {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9rem;
    margin-top: 10px;
  }
  .map-controls {
    margin-bottom: 10px;
  }
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100px;
  }
  .leaflet-container .leaflet-control-attribution {
    font-size: 10px;
  }
</style>
{% endblock %} {% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
          <i class="bi bi-{{ listing|yesno:'pencil,plus-circle' }}"></i>
          {{ title|default:"Create Housing Listing" }}
        </h4>
      </div>
      <div class="card-body">
        {% if form.errors %}
        <div class="alert alert-danger">
          <h5 class="alert-heading">
            <i class="bi bi-exclamation-triangle"></i> Please correct these
            errors:
          </h5>
          <ul class="mb-0">
            {% for field in form %} {% if field.errors %}
            <li><strong>{{ field.label }}:</strong> {{ field.errors.0 }}</li>
            {% endif %} {% endfor %} {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="listingForm">
          {% csrf_token %}

          <!-- Section 1: Basic Information -->
          <div class="form-section">
            <h5 class="section-title">Basic Information</h5>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_listing_type" class="form-label required-field"
                  >Listing Type</label
                >
                {{ form.listing_type }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_property_type" class="form-label required-field"
                  >Property Type</label
                >
                {{ form.property_type }}
              </div>
            </div>

            <div class="mb-3">
              <label for="id_title" class="form-label required-field"
                >Listing Title</label
              >
              {{ form.title }}
              <div class="form-text">
                Make it descriptive (e.g., "Spacious 2-Bedroom Apartment near
                Campus")
              </div>
            </div>

            <div class="mb-3">
              <label for="id_description" class="form-label required-field"
                >Description</label
              >
              {{ form.description }}
              <div class="form-text">
                Describe the property, neighborhood, and any special features
              </div>
            </div>
          </div>

          <!-- Section 2: Location -->
          <div class="form-section">
            <h5 class="section-title">Location Details</h5>

            <div class="row">
              <div class="col-md-8 mb-3">
                <label for="id_address" class="form-label required-field"
                  >Full Address</label
                >
                {{ form.address }}
              </div>
              <div class="col-md-4 mb-3">
                <label for="id_city" class="form-label required-field"
                  >City</label
                >
                {{ form.city }}
              </div>
            </div>

            <div class="mb-3">
              <label for="id_neighborhood" class="form-label"
                >Neighborhood/Area</label
              >
              {{ form.neighborhood }}
              <div class="form-text">
                Optional: Specific area or neighborhood
              </div>
            </div>

            <!-- Map Integration -->
            <div class="mb-4">
              <label class="form-label">
                <i class="bi bi-map text-primary me-1"></i> Property Location on
                Map
              </label>
              <div class="map-instructions">
                <i class="bi bi-info-circle"></i>
                Click on the map to set the exact location of your property.
                This helps potential renters find your location easily.
              </div>

              <!-- Hidden coordinate fields -->
              <div id="property-map" class="mb-3"></div>

              <div class="map-coordinates">
                <span id="coordinates-display"
                  >No location selected. Click on the map to set location.</span
                >
              </div>

              <div class="map-controls mt-3">
                <button
                  type="button"
                  id="locate-me"
                  class="btn btn-sm btn-outline-info"
                >
                  <i class="bi bi-geo-alt me-1"></i> Use My Location
                </button>
                <button
                  type="button"
                  id="search-address"
                  class="btn btn-sm btn-outline-primary ms-2"
                >
                  <i class="bi bi-search me-1"></i> Search Address
                </button>
                <button
                  type="button"
                  id="clear-marker"
                  class="btn btn-sm btn-outline-danger ms-2"
                >
                  <i class="bi bi-x-circle me-1"></i> Clear Marker
                </button>
              </div>
            </div>
          </div>

          <!-- Hidden latitude/longitude fields (rendered by Django form) -->
          {{ form.latitude }} {{ form.longitude }}

          <!-- Section 3: Pricing -->
          <div class="form-section">
            <h5 class="section-title">Pricing Details</h5>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_price" class="form-label required-field"
                  >Price</label
                >
                <div class="input-group">
                  <span class="input-group-text">KSh</span>
                  {{ form.price }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_price_period" class="form-label required-field"
                  >Price Period</label
                >
                {{ form.price_period }}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_deposit" class="form-label"
                  >Security Deposit</label
                >
                <div class="input-group">
                  <span class="input-group-text">KSh</span>
                  {{ form.deposit }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-check mt-4">
                  {{ form.utilities_included }}
                  <label class="form-check-label" for="id_utilities_included">
                    Utilities Included
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Section 4: Property Details -->
          <div class="form-section">
            <h5 class="section-title">Property Details</h5>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="id_bedrooms" class="form-label required-field"
                  >Bedrooms</label
                >
                {{ form.bedrooms }}
              </div>
              <div class="col-md-4 mb-3">
                <label for="id_bathrooms" class="form-label required-field"
                  >Bathrooms</label
                >
                {{ form.bathrooms }}
                <div class="form-text">Can be 1.5, 2.5, etc.</div>
              </div>
              <div class="col-md-4 mb-3">
                <label for="id_square_meters" class="form-label"
                  >Size (m¬≤)</label
                >
                {{ form.square_meters }}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_furnished" class="form-label required-field"
                  >Furnishing</label
                >
                {{ form.furnished }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_amenities" class="form-label">Amenities</label>
                {{ form.amenities }}
                <div class="form-text">
                  Comma separated: WiFi, Parking, Pool, Gym, etc.
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_available_from" class="form-label required-field"
                  >Available From</label
                >
                {{ form.available_from }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_lease_duration" class="form-label"
                  >Lease Duration</label
                >
                {{ form.lease_duration }}
                <div class="form-text">
                  e.g., 1 year, 6 months, month-to-month
                </div>
              </div>
            </div>
          </div>

          <!-- Section 5: Contact Information -->
          <div class="form-section">
            <h5 class="section-title">Contact Information</h5>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_contact_name" class="form-label required-field"
                  >Contact Name</label
                >
                {{ form.contact_name }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_contact_phone" class="form-label required-field"
                  >Contact Phone</label
                >
                {{ form.contact_phone }}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_contact_email" class="form-label"
                  >Contact Email</label
                >
                {{ form.contact_email }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_contact_preference" class="form-label"
                  >Preferred Contact Method</label
                >
                {{ form.contact_preference }}
              </div>
            </div>
          </div>

          <!-- Section 6: Images -->
          <div class="form-section">
            <h5 class="section-title">Property Images</h5>
            <p class="text-muted mb-3">
              Upload up to 4 images. First image will be the main display image.
            </p>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_main_image" class="form-label">Main Image</label>
                {{ form.main_image }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_image_2" class="form-label"
                  >Image 2 (Optional)</label
                >
                {{ form.image_2 }}
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_image_3" class="form-label"
                  >Image 3 (Optional)</label
                >
                {{ form.image_3 }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_image_4" class="form-label"
                  >Image 4 (Optional)</label
                >
                {{ form.image_4 }}
              </div>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="d-flex justify-content-between">
            {% if listing %}
            <a
              href="{% url 'housing:listing_detail' listing.pk %}"
              class="btn btn-secondary"
            >
              <i class="bi bi-x-circle"></i> Cancel
            </a>
            {% else %}
            <a href="{% url 'housing:home' %}" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i> Cancel
            </a>
            {% endif %}

            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save"></i> {{ listing|yesno:"Update,Create" }}
              Listing
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // Make sure the DOM is fully loaded
  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM loaded, initializing map...");
    initializePropertyMap();

    // Existing form validation
    const form = document.getElementById("listingForm");
    const requiredFields = form.querySelectorAll("[required]");

    form.addEventListener("submit", function (e) {
      let isValid = true;

      requiredFields.forEach(function (field) {
        if (!field.value.trim()) {
          field.classList.add("is-invalid");
          isValid = false;
        } else {
          field.classList.remove("is-invalid");
        }
      });

      // Validate price
      const priceField = document.getElementById("id_price");
      if (priceField.value && parseFloat(priceField.value) <= 0) {
        priceField.classList.add("is-invalid");
        alert("Price must be greater than 0");
        isValid = false;
      }

      if (!isValid) {
        e.preventDefault();
        alert("Please fill in all required fields correctly.");
      }
    });

    // Remove invalid class when user starts typing
    requiredFields.forEach(function (field) {
      field.addEventListener("input", function () {
        if (this.value.trim()) {
          this.classList.remove("is-invalid");
        }
      });
    });
  });

  function initializePropertyMap() {
    console.log("Initializing property map...");

    // Default coordinates (Nairobi)
    const defaultLat = -1.286389;
    const defaultLng = 36.817223;

    // Get hidden input fields
    const latInput = document.getElementById("id_latitude");
    const lngInput = document.getElementById("id_longitude");
    const coordsDisplay = document.getElementById("coordinates-display");

    if (!latInput || !lngInput || !coordsDisplay) {
      console.error("Missing required map elements");
      return;
    }

    console.log("Lat input value:", latInput.value);
    console.log("Lng input value:", lngInput.value);

    // Get existing coordinates if editing
    let currentLat = latInput.value ? parseFloat(latInput.value) : defaultLat;
    let currentLng = lngInput.value ? parseFloat(lngInput.value) : defaultLng;

    // Initialize map
    console.log("Initializing Leaflet map...");
    const map = L.map("property-map").setView([currentLat, currentLng], 13);

    // Add OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Create a custom icon
    const propertyIcon = L.divIcon({
      html: '<div style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; font-weight: bold;"><i class="bi bi-house-door"></i> Property</div>',
      className: "custom-div-icon",
      iconSize: [120, 40],
      iconAnchor: [60, 40],
    });

    // Add marker if coordinates exist
    let marker = null;
    if (latInput.value && lngInput.value) {
      console.log("Adding existing marker at:", currentLat, currentLng);
      marker = L.marker([currentLat, currentLng], { icon: propertyIcon }).addTo(
        map
      );
      updateCoordinatesDisplay(currentLat, currentLng);
    }

    // Add click event to place marker
    map.on("click", function (e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      console.log("Map clicked at:", lat, lng);

      placeMarker(lat, lng);
    });

    // Locate Me button
    const locateBtn = document.getElementById("locate-me");
    if (locateBtn) {
      locateBtn.addEventListener("click", function () {
        console.log("Locate me clicked");
        if ("geolocation" in navigator) {
          coordsDisplay.textContent = "Getting your location...";
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              console.log("Got location:", lat, lng);
              placeMarker(lat, lng);
              map.setView([lat, lng], 15);
            },
            function (error) {
              console.error("Geolocation error:", error);
              let errorMsg = "Unable to get your location. ";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  errorMsg +=
                    "Please allow location access in your browser settings.";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMsg += "Location information is unavailable.";
                  break;
                case error.TIMEOUT:
                  errorMsg += "The request to get your location timed out.";
                  break;
                default:
                  errorMsg += "An unknown error occurred.";
              }
              coordsDisplay.textContent = errorMsg;
              alert(errorMsg);
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0,
            }
          );
        } else {
          alert("Geolocation is not supported by your browser.");
        }
      });
    }

    // Search Address button
    const searchBtn = document.getElementById("search-address");
    if (searchBtn) {
      searchBtn.addEventListener("click", function () {
        console.log("Search address clicked");
        const address = document.getElementById("id_address").value;
        const city = document.getElementById("id_city").value || "Nairobi";

        if (!address.trim()) {
          alert("Please enter an address in the 'Full Address' field first.");
          return;
        }

        // Show loading
        coordsDisplay.textContent = "Searching for address...";

        // Use Nominatim API for geocoding
        const searchQuery = `${address}, ${city}, Kenya`;
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(
          searchQuery
        )}&format=json&limit=1`;

        console.log("Searching for:", searchQuery);

        fetch(url, {
          headers: {
            "User-Agent": "CampusMarketplace/1.0 (contact@example.com)",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Geocoding response:", data);
            if (data && data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lng = parseFloat(data[0].lon);
              console.log("Found location:", lat, lng);
              placeMarker(lat, lng);
              map.setView([lat, lng], 15);
            } else {
              coordsDisplay.textContent =
                "Address not found. Please try a different address or manually select on map.";
              console.warn("Address not found");
            }
          })
          .catch((error) => {
            console.error("Geocoding error:", error);
            coordsDisplay.textContent =
              "Error searching address. Please try manually selecting on map.";
            alert(
              "There was an error searching for the address. Please try again or select the location manually on the map."
            );
          });
      });
    }

    // Clear Marker button
    const clearBtn = document.getElementById("clear-marker");
    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        console.log("Clear marker clicked");
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        latInput.value = "";
        lngInput.value = "";
        coordsDisplay.textContent =
          "No location selected. Click on the map to set location.";
      });
    }

    function placeMarker(lat, lng) {
      console.log("Placing marker at:", lat, lng);

      // Round to 6 decimal places to match form validation
      lat = parseFloat(lat.toFixed(6));
      lng = parseFloat(lng.toFixed(6));

      // Remove existing marker
      if (marker) {
        map.removeLayer(marker);
      }

      // Add new marker
      marker = L.marker([lat, lng], { icon: propertyIcon }).addTo(map);

      // Update hidden inputs
      latInput.value = lat;
      lngInput.value = lng;

      // Update display
      updateCoordinatesDisplay(lat, lng);

      // Add popup
      marker
        .bindPopup(
          `
        <div style="font-size: 14px;">
            <strong><i class="bi bi-house-door"></i> Property Location</strong><br>
            Latitude: ${lat.toFixed(6)}<br>
            Longitude: ${lng.toFixed(6)}<br>
            <small>Click outside to close</small>
        </div>
    `
        )
        .openPopup();
    }

    function updateCoordinatesDisplay(lat, lng) {
      coordsDisplay.textContent = `üìç Location set! Latitude: ${lat.toFixed(
        6
      )}, Longitude: ${lng.toFixed(6)}`;
      coordsDisplay.style.color = "#28a745";
      coordsDisplay.style.fontWeight = "bold";
    }

    console.log("Map initialization complete");
  }
</script>
{% endblock %}
